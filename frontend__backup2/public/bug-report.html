<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bug Report Form</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #0b1021;
      color: white;
    }
    .container {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 40px;
    }
    h1 {
      font-size: 24px;
      background: linear-gradient(to right, #6d4aff, #8c5eff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
    }
    .back-button {
      display: inline-block;
      padding: 8px 20px;
      background-color: #242d4f;
      color: white;
      text-decoration: none;
      border-radius: 9999px; /* Oval edges like the Bug Report Form button */
      transition: background-color 0.2s;
      font-weight: 500; /* medium font weight */
      font-size: 16px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    .back-button:hover {
      background-color: #343e60;
    }
    .form-container {
      max-width: 600px;
      margin: 0 auto;
      background-color: #121833;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .form-group {
      margin-bottom: 16px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      color: #8c8c8c;
    }
    input, textarea, select {
      width: 100%;
      padding: 8px;
      background-color: #0f1428;
      border: 1px solid #1e2642;
      color: white;
      border-radius: 4px;
      box-sizing: border-box;
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    .submit-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-left: auto;
      padding: 10px 24px;
      background: linear-gradient(to right, #6d4aff, #8c5eff);
      color: white;
      border: none;
      border-radius: 9999px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: opacity 0.2s;
    }
    .submit-button:hover {
      opacity: 0.9;
    }
    .submit-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .button {
      display: inline-flex;
      align-items: center;
      padding: 8px 16px;
      background-color: #242d4f;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .button:hover {
      background-color: #343e60;
    }
    .button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .checkbox-container {
      display: flex;
      align-items: center;
      margin-top: 16px;
    }
    .checkbox-container input {
      width: auto;
      margin-right: 8px;
    }
    .checkbox-container label {
      margin-bottom: 0;
      font-size: 14px;
    }
    .file-upload-container {
      border: 2px dashed #1e2642;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      transition: border-color 0.2s;
    }
    .file-upload-container:hover {
      border-color: #6d4aff;
    }
    .file-input {
      display: none;
    }
    .file-list {
      margin-top: 16px;
      padding: 0;
      list-style: none;
    }
    .file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      margin-bottom: 8px;
      background-color: #0f1428;
      border-radius: 4px;
    }
    .file-info {
      display: flex;
      align-items: center;
    }
    .file-name {
      margin-right: 8px;
    }
    .file-status {
      font-size: 12px;
    }
    .status-uploading {
      color: #ffc107;
    }
    .status-scanning {
      color: #ffc107;
    }
    .status-ready {
      color: #28a745;
    }
    .status-error {
      color: #dc3545;
    }
    .remove-file {
      color: #dc3545;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }
    .info-message {
      margin-top: 8px;
      font-size: 14px;
      color: #8c8c8c;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Bug Report Form</h1>
      <a href="/" class="back-button" style="padding: 8px 20px;">Back to Chat</a>
    </header>
    
    <div class="form-container">
      <form id="bugReportForm">
        <!-- Reporter Information -->
        <h3>Reporter Information</h3>
        <div class="form-group">
          <label for="reporterName">Your Name</label>
          <input type="text" id="reporterName" name="reporterName" required>
        </div>
        
        <div class="form-group">
          <label for="reporterEmail">Your Email</label>
          <input type="email" id="reporterEmail" name="reporterEmail" required>
        </div>
        
        <!-- Device Information -->
        <h3>Device Information</h3>
        <div class="form-group">
          <label for="appVersion">App Version (e.g. 8.0.0 (1234)) See Help > scroll to the bottom</label>
          <input type="text" id="appVersion" name="appVersion" required>
        </div>
        
        <div class="form-group">
          <label for="deviceOS">Device/OS (e.g. iPad Pro 11" M2, iPadOS 17.4)</label>
          <input type="text" id="deviceOS" name="deviceOS" required>
        </div>
        
        <!-- Bug Description -->
        <h3>Bug Description</h3>
        <div class="form-group">
          <label for="stepsToReproduce">Steps to Reproduce (at least 3 steps)</label>
          <textarea id="stepsToReproduce" name="stepsToReproduce" required></textarea>
        </div>
        
        <div class="form-group">
          <label for="expectedResult">Expected Result</label>
          <textarea id="expectedResult" name="expectedResult" required></textarea>
        </div>
        
        <div class="form-group">
          <label for="actualResult">Actual Result</label>
          <textarea id="actualResult" name="actualResult" required></textarea>
        </div>
        
        <div class="form-group">
          <label for="severity">Severity</label>
          <select id="severity" name="severity" required>
            <option value="">Select Severity</option>
            <option value="Critical">Critical</option>
            <option value="High">High</option>
            <option value="Medium">Medium</option>
            <option value="Low">Low</option>
          </select>
        </div>
        
        <!-- File Attachments -->
        <h3>Attachments (Optional)</h3>
        <div class="file-upload-container" id="dropZone">
          <div style="text-align: center;">
            <p class="info-message">
              Drag & drop files here, or click anywhere in this box to select files (up to 3 files, 100 MB each)
            </p>
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#6d4aff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="12" y1="18" x2="12" y2="12"></line>
              <line x1="9" y1="15" x2="15" y2="15"></line>
            </svg>
          </div>
          <input type="file" id="fileInput" style="display: none;" multiple>
          <ul class="file-list" id="fileList"></ul>
        </div>
        <div id="skipAttachmentsContainer" class="hidden">
          <button type="button" id="skipAttachmentsButton" class="button">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
            Skip Attachments
          </button>
        </div>
        
        <!-- GDPR Consent -->
        <div class="checkbox-container">
          <input type="checkbox" id="gdprConsent" name="gdprConsent" required>
          <label for="gdprConsent">I consent to storage of diagnostic data for troubleshooting purposes (GDPR)</label>
        </div>
        
        <!-- Submit Button -->
        <div style="margin-top: 24px; text-align: right;">
          <button type="submit" id="submitButton" class="submit-button">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 2v20h-20v-20h20zm-10 10v6m0-12v2m-6 16v-12m12 12v-12"></path>
            </svg>
            Submit Bug Report
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOMContentLoaded event fired');
      // Constants
      const BACKEND_URL = window.location.origin; // Use the current origin instead of hardcoded URL
      const USE_ZENDESK = true; // Set to true to enable Zendesk integration
      const DEBUG_MODE = true; // Enable debug logging
      
      // Verify critical DOM elements on load and set up test function
      window.addEventListener('DOMContentLoaded', function() {
        console.log('Document loaded, verifying critical elements:');
        console.log('fileInput element:', document.getElementById('fileInput'));
        console.log('selectFilesButton element:', document.getElementById('selectFilesButton'));
        console.log('dropZone element:', document.getElementById('dropZone'));
        console.log('fileList element:', document.getElementById('fileList'));
        
        // Create test file upload function accessible from console
        window.testFileUpload = function() {
          try {
            console.log('Testing file upload functionality...');
            
            // Create a simple text file for testing
            const blob = new Blob(['This is a test file content'], { type: 'text/plain' });
            const testFile = new File([blob], 'test-file.txt', { type: 'text/plain' });
            
            console.log('Test file created:', testFile);
            
            // Call handleFiles directly
            handleFiles([testFile]);
            
            return 'Test file upload initiated. Check console for results.';
          } catch (err) {
            console.error('Error in test file upload:', err);
            return 'Error in test file upload: ' + err.message;
          }
        };
        
        console.log('Test function created. Run window.testFileUpload() from console to test.');
      });
      
      // Make USE_ZENDESK available globally for error handling
      window.USE_ZENDESK = USE_ZENDESK;
      
      // Debug logging function
      function debugLog(message, data) {
        if (DEBUG_MODE) {
          const timestamp = new Date().toISOString();
          console.log(`[DEBUG ${timestamp}] ${message}`, data !== undefined ? data : '');
        }
      }
      
      debugLog('Bug report form initialized');
      const MAX_FILES = 3;
      const MAX_FILE_SIZE = 100 * 1024 * 1024; // 100MB in bytes
      
      // Elements
      const dropZone = document.getElementById('dropZone');
      const fileInput = document.getElementById('fileInput');
      const selectFilesButton = document.getElementById('selectFilesButton');
      const fileList = document.getElementById('fileList');
      const skipAttachmentsContainer = document.getElementById('skipAttachmentsContainer');
      const skipAttachmentsButton = document.getElementById('skipAttachmentsButton');
      const submitButton = document.getElementById('submitButton');
      const bugReportForm = document.getElementById('bugReportForm');
      
      // State
      let files = [];
      let uploadedFiles = [];
      let pollingIntervals = {};
      let allFilesReady = false;
      
      // Initialize
      function init() {
        console.log('Init function called');
        
        // Verify all DOM elements are found
        if (!fileInput) {
          console.error('ERROR: fileInput element not found');
          return;
        }
        
        if (!selectFilesButton) {
          console.error('ERROR: selectFilesButton element not found');
          return;
        }
        
        if (!dropZone) {
          console.error('ERROR: dropZone element not found');
          return;
        }
        
        console.log('All required DOM elements found, proceeding with initialization');
        // Set up file selection click with try/catch for debugging
        debugLog('Setting up file selection button click event');
        try {
          selectFilesButton.addEventListener('click', function(e) {
          debugLog('Select files button clicked');
          e.preventDefault(); // Prevent any default action
          try {
            fileInput.click();
            debugLog('fileInput.click() executed');
          } catch (clickErr) {
            console.error('Error clicking file input:', clickErr);
          }
        });
        } catch (eventErr) {
          console.error('Error setting up click event listener:', eventErr);
        }
        
        // Set up file input change with try/catch
        debugLog('Setting up file input change event');
        try {
          fileInput.addEventListener('change', function(e) {
          debugLog('File input change event triggered', { fileCount: e.target.files?.length || 0 });
          if (e.target.files && e.target.files.length > 0) {
            handleFiles(Array.from(e.target.files));
            this.value = null; // Reset so same file can be selected again
          } else {
            debugLog('No files selected in file input change event');
          }
        });
        } catch (eventErr) {
          console.error('Error setting up change event listener:', eventErr);
        }
        
        // Set up drag and drop
        debugLog('Setting up drag and drop events');
        dropZone.addEventListener('dragover', function(e) {
          debugLog('Dragover event on drop zone');
          e.preventDefault();
          e.stopPropagation();
          dropZone.style.borderColor = '#6d4aff';
        });
        
        dropZone.addEventListener('dragleave', function(e) {
          debugLog('Dragleave event on drop zone');
          e.preventDefault();
          e.stopPropagation();
          dropZone.style.borderColor = '#1e2642';
        });
        
        dropZone.addEventListener('drop', function(e) {
          debugLog('Drop event on drop zone', { fileCount: e.dataTransfer?.files?.length || 0 });
          e.preventDefault();
          e.stopPropagation();
          dropZone.style.borderColor = '#1e2642';
          
          if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            debugLog('Files dropped, handling files');
            handleFiles(Array.from(e.dataTransfer.files));
          } else {
            debugLog('No files found in drop event');
          }
        });
        
        // Add drop events to document to prevent browser from opening files
        document.addEventListener('dragover', function(e) {
          e.preventDefault();
          e.stopPropagation();
        });
        
        document.addEventListener('drop', function(e) {
          e.preventDefault();
          e.stopPropagation();
        });
        
        // Set up skip attachments button
        skipAttachmentsButton.addEventListener('click', function() {
          skipAttachments();
        });
        
        // Set up form submission
        bugReportForm.addEventListener('submit', function(e) {
          e.preventDefault();
          submitReport();
        });
      }
      
      // Handle file selection
      function handleFiles(newFiles) {
        console.log('handleFiles function called with:', newFiles);
        debugLog('handleFiles called with files count:', newFiles?.length || 0);
        // Check if files are valid
        if (!newFiles || newFiles.length === 0) {
          console.error('No files provided to handleFiles function');
          return;
        }
        
        // Check if max files reached
        const availableSlots = MAX_FILES - files.length;
        debugLog('Available file slots:', availableSlots);
        if (availableSlots <= 0) {
          alert(`Maximum ${MAX_FILES} files allowed. Please remove some files before adding more.`);
          return;
        }
        
        // Process only up to available slot count
        const filesToAdd = newFiles.slice(0, availableSlots);
        
        // Check file sizes
        for (const file of filesToAdd) {
          if (file.size > MAX_FILE_SIZE) {
            alert(`File ${file.name} exceeds the maximum size of 100MB.`);
            return;
          }
        }
        
        // Add files to array and display
        for (const file of filesToAdd) {
          const fileId = `file-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
          
          // Add to files array
          files.push({
            id: fileId,
            file: file,
            status: 'Uploading...',
            s3Key: null
          });
          
          // Display in list
          addFileToList(fileId, file.name, 'Uploading...');
          
          // Upload file
          uploadFile(fileId, file);
        }
        
        // Update UI
        updateFileUploadUI();
      }
      
      // Add file to visual list
      function addFileToList(fileId, fileName, status) {
        const li = document.createElement('li');
        li.className = 'file-item';
        li.dataset.fileId = fileId;
        
        let statusClass = '';
        switch (status.toLowerCase()) {
          case 'uploading...':
            statusClass = 'status-uploading';
            break;
          case 'scanning...':
          case 'uploaded, scanning...':
            statusClass = 'status-scanning';
            break;
          case 'clean (ready)':
            statusClass = 'status-ready';
            break;
          default:
            if (status.toLowerCase().includes('error') || status.toLowerCase().includes('infected')) {
              statusClass = 'status-error';
            }
        }
        
        li.innerHTML = `
          <div class="file-info">
            <span class="file-name">${fileName}</span>
            <span class="file-status ${statusClass}">${status}</span>
          </div>
          <button type="button" class="remove-file" data-file-id="${fileId}">&times;</button>
        `;
        
        fileList.appendChild(li);
        
        // Add remove button event listener
        li.querySelector('.remove-file').addEventListener('click', function() {
          removeFile(fileId);
        });
      }
      
      // Update file status in the list
      function updateFileStatus(fileId, status) {
        const li = fileList.querySelector(`li[data-file-id="${fileId}"]`);
        if (li) {
          const statusEl = li.querySelector('.file-status');
          
          // Update status text
          statusEl.textContent = status;
          
          // Update status class
          statusEl.classList.remove('status-uploading', 'status-scanning', 'status-ready', 'status-error');
          
          let statusClass = '';
          switch (status.toLowerCase()) {
            case 'uploading...':
              statusClass = 'status-uploading';
              break;
            case 'scanning...':
            case 'uploaded, scanning...':
              statusClass = 'status-scanning';
              break;
            case 'clean (ready)':
              statusClass = 'status-ready';
              break;
            default:
              if (status.toLowerCase().includes('error') || status.toLowerCase().includes('infected')) {
                statusClass = 'status-error';
              }
          }
          
          statusEl.classList.add(statusClass);
        }
      }
      
      // Remove file from list and state
      function removeFile(fileId) {
        // Clear polling interval if exists
        if (pollingIntervals[fileId]) {
          clearInterval(pollingIntervals[fileId]);
          delete pollingIntervals[fileId];
        }
        
        // Remove from files array
        files = files.filter(f => f.id !== fileId);
        
        // Remove from uploadedFiles array
        uploadedFiles = uploadedFiles.filter(f => f.id !== fileId);
        
        // Remove from DOM
        const li = fileList.querySelector(`li[data-file-id="${fileId}"]`);
        if (li) {
          li.remove();
        }
        
        // Update UI
        updateFileUploadUI();
      }
      
      // Update file upload UI based on current state
      function updateFileUploadUI() {
        // Show/hide skip attachments button based on file count
        if (files.length > 0) {
          skipAttachmentsContainer.classList.remove('hidden');
        } else {
          skipAttachmentsContainer.classList.add('hidden');
        }
        
        // Update selectFilesButton
        if (files.length >= MAX_FILES) {
          selectFilesButton.disabled = true;
          selectFilesButton.textContent = 'Maximum files reached';
        } else {
          selectFilesButton.disabled = false;
          selectFilesButton.textContent = 'Select Files';
        }
        
        // Check if all files are ready
        checkAllFilesReady();
      }
      
      // Check if all files are ready for submission
      function checkAllFilesReady() {
        allFilesReady = files.length > 0 && 
                         files.every(file => file.status === 'Clean (ready)' || file.status.includes('Infected'));
      }
      
      // Upload file to S3/R2
      async function uploadFile(fileId, file) {
        try {
          // Find file in array
          const fileIndex = files.findIndex(f => f.id === fileId);
          if (fileIndex === -1) return;
          
          // Prepare file metadata
          const safeName = file.name.replace(/\s+/g, "_");
          const meta = { 
            name: safeName, 
            type: file.type, 
            size: file.size 
          };
          
          // Request presigned URL
          const presignRes = await fetch(`${BACKEND_URL}/generate-presigned-url`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(meta)
          });
          
          if (!presignRes.ok) {
            throw new Error(`Failed to get presigned URL: ${presignRes.status}`);
          }
          
          const { url, key } = await presignRes.json();
          
          // Upload to S3/R2
          const uploadRes = await fetch(url, {
            method: 'PUT',
            body: file,
            headers: { 'Content-Type': file.type }
          });
          
          if (!uploadRes.ok) {
            throw new Error('Failed to upload file to storage');
          }
          
          // Update file status
          files[fileIndex].status = 'Uploaded, scanning...';
          files[fileIndex].s3Key = key;
          updateFileStatus(fileId, 'Uploaded, scanning...');
          
          // Start polling for scan status
          pollForScanResult(fileId, key);
          
        } catch (error) {
          console.error('Upload error:', error);
          
          // Update file status with error
          const fileIndex = files.findIndex(f => f.id === fileId);
          if (fileIndex !== -1) {
            files[fileIndex].status = `Error: ${error.message}`;
            updateFileStatus(fileId, `Error: ${error.message}`);
          }
        }
      }
      
      // Poll for virus scan result
      function pollForScanResult(fileId, tempKey) {
        // Find file in array
        const fileIndex = files.findIndex(f => f.id === fileId);
        if (fileIndex === -1) return;
        
        // Update status to scanning
        files[fileIndex].status = 'Scanning...';
        updateFileStatus(fileId, 'Scanning...');
        
        // For testing/debugging only: automatically mark as clean after a few seconds
        // This simulates the virus scan completing successfully
        // Remove this code in production when actual scanning works
        let testRetryCount = 0;
        
        let retries = 60; // 2 minutes (120 seconds at 2-second intervals)
        const permKey = tempKey.replace('temp/', 'permanent/');
        
        const checkStatus = async () => {
          try {
            // --- DEBUGGING MODE ONLY: AUTO-SUCCEED AFTER 5 RETRIES IF NO VALID BACKEND ---
            // In production with a proper backend, this code would be removed
            testRetryCount++;
            const debugModeAutoSucceed = true; // Set to false to disable auto-success in production
            
            if (debugModeAutoSucceed && testRetryCount >= 5) {
              console.log("[DEBUG] Simulating successful virus scan (debug mode fallback)");
              const fileIndex = files.findIndex(f => f.id === fileId);
              if (fileIndex !== -1) {
                files[fileIndex].status = 'Clean (ready)';
                files[fileIndex].s3Key = permKey;
                updateFileStatus(fileId, 'Clean (ready)');
                
                // Add to uploadedFiles array
                uploadedFiles.push({
                  id: fileId,
                  key: permKey
                });
                
                // Update UI
                updateFileUploadUI();
                
                // Clear interval
                clearInterval(pollingIntervals[fileId]);
                delete pollingIntervals[fileId];
              }
              return;
            }
            // --- END DEBUGGING FALLBACK ---
            
            // First check if file is still in temp (scanning)
            const tempRes = await fetch(`${BACKEND_URL}/check-file-status?key=${encodeURIComponent(tempKey)}`, {
              method: 'HEAD'
            });
            
            if (tempRes.status === 200) {
              // File is still in temp, still scanning
              return;
            }
            
            // Then check if file is in permanent (clean)
            const permRes = await fetch(`${BACKEND_URL}/check-file-status?key=${encodeURIComponent(permKey)}`, {
              method: 'HEAD'
            });
            
            if (permRes.status === 200) {
              // File is clean and in permanent storage
              const fileIndex = files.findIndex(f => f.id === fileId);
              if (fileIndex !== -1) {
                files[fileIndex].status = 'Clean (ready)';
                files[fileIndex].s3Key = permKey;
                updateFileStatus(fileId, 'Clean (ready)');
                
                // Add to uploadedFiles array
                uploadedFiles.push({
                  id: fileId,
                  key: permKey
                });
                
                // Update UI
                updateFileUploadUI();
                
                // Clear interval
                clearInterval(pollingIntervals[fileId]);
                delete pollingIntervals[fileId];
              }
              return;
            }
            
            // If not in temp or permanent after retries, mark as infected/deleted
            if (--retries <= 0) {
              const fileIndex = files.findIndex(f => f.id === fileId);
              if (fileIndex !== -1) {
                files[fileIndex].status = 'Infected (deleted)';
                updateFileStatus(fileId, 'Infected (deleted)');
                
                // Clear interval
                clearInterval(pollingIntervals[fileId]);
                delete pollingIntervals[fileId];
              }
            }
          } catch (error) {
            console.error('Status check error:', error);
          }
        };
        
        // Start polling
        pollingIntervals[fileId] = setInterval(checkStatus, 2000);
        checkStatus(); // First check immediately
      }
      
      // Skip attachments
      function skipAttachments() {
        // Clear all files
        files.forEach(file => {
          if (pollingIntervals[file.id]) {
            clearInterval(pollingIntervals[file.id]);
            delete pollingIntervals[file.id];
          }
        });
        
        files = [];
        uploadedFiles = [];
        fileList.innerHTML = '';
        
        // Add a placeholder file to indicate skipped attachments
        uploadedFiles.push({
          id: 'skipped-attachments',
          key: 'skipped-attachments'
        });
        
        // Hide skip attachments button
        skipAttachmentsContainer.classList.add('hidden');
        
        // Enable submit
        allFilesReady = true;
      }
      
      // Submit bug report
      async function submitReport() {
        // Get form data
        const formData = {
          reporterName: document.getElementById('reporterName').value,
          reporterEmail: document.getElementById('reporterEmail').value,
          appVersion: document.getElementById('appVersion').value,
          deviceOS: document.getElementById('deviceOS').value,
          stepsToReproduce: document.getElementById('stepsToReproduce').value,
          expectedResult: document.getElementById('expectedResult').value,
          actualResult: document.getElementById('actualResult').value,
          severity: document.getElementById('severity').value,
          gdprConsent: document.getElementById('gdprConsent').checked
        };
        
        // Validate form
        if (!formData.reporterName || !formData.reporterEmail || !formData.appVersion || 
            !formData.deviceOS || !formData.stepsToReproduce || !formData.expectedResult || 
            !formData.actualResult || !formData.severity || !formData.gdprConsent) {
          alert('Please fill in all required fields.');
          return;
        }
        
        try {
          // Disable submit button
          submitButton.disabled = true;
          submitButton.textContent = 'Submitting...';
          
          // Get attachment keys
          const attachmentKeys = uploadedFiles.map(file => file.key);
          
          // For demo/testing purposes: Display submission data
          console.log("Submission data:", {
            formData: formData,
            attachments: attachmentKeys
          });
          
          try {
            if (USE_ZENDESK) {
              // Use Zendesk integration
              return await submitToZendesk(formData, attachmentKeys);
            } else {
              // Use original Form Collector integration
              // Prepare submission data for the API call
              const submissionData = {
                session_id: `direct-bug-form-${Date.now()}`,
                user_message: 'Submit bug report',
                meta: {
                  form_data: formData,
                  attachments: attachmentKeys,
                  submit: true,
                  agent_type: 'bug_report'
                }
              };
              
              console.log('Submitting bug report data:', submissionData);
              
              // Submit to backend with proper error handling
              const res = await fetch(`${BACKEND_URL}/api/form-collector/chat`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-Agent-Type': 'bug_report',
                  'X-Submit-Action': 'true'
                },
                body: JSON.stringify(submissionData)
              });
            
            if (!res.ok) {
              const errorText = await res.text();
              throw new Error(`Submission failed (${res.status}): ${errorText || res.statusText}`);
            }
            
            // Process successful response
            const responseData = await res.json();
            console.log('Bug report submission successful:', responseData);
            
            // Show success message
            bugReportForm.innerHTML = `
              <div style="text-align: center; padding: 20px;">
                <h2 style="color: #28a745;">Bug Report Submitted Successfully!</h2>
                <p>Thank you for your feedback. Your report has been submitted and will be reviewed by our team.</p>
                <p>Reference ID: ${responseData.reference_id || responseData.ticket_id || 'N/A'}</p>
                <a href="/" class="back-button" style="margin-top: 20px; border-radius: 9999px; display: inline-block; padding: 8px 20px; font-weight: 500; font-size: 16px;">Return to Home</a>
              </div>
            `;
            
            return true;
          } 
          
          // Function to submit the bug report to Zendesk
          async function submitToZendesk(formData, attachmentKeys) {
            try {
              // Disable submit button while processing
              submitButton.disabled = true;
              submitButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="animate-spin h-5 w-5 mr-2" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M12 6v6l4 2"></path></svg> Creating Zendesk Ticket...';
              
              console.log('Submitting bug report to Zendesk');
              debugLog('Starting Zendesk submission process');
              
              // Step 1: Create ticket in Zendesk
              // Use absolute URL to ensure correct endpoint
              const baseUrl = window.location.origin;
              const createTicketUrl = `${baseUrl}/api/zendesk/create-ticket`;
              debugLog('Creating ticket in Zendesk at URL:', createTicketUrl);
              
              const createTicketRes = await fetch(createTicketUrl, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  formData: formData,
                  attachments: attachmentKeys
                })
              });
              
              if (!createTicketRes.ok) {
                const errorText = await createTicketRes.text();
                let errorMessage = `Failed to create Zendesk ticket: ${createTicketRes.statusText}`;
                
                try {
                  // Try to parse error for more helpful messages
                  const errorJson = JSON.parse(errorText);
                  if (errorJson.error) {
                    errorMessage = `Zendesk Error: ${errorJson.error}`;
                  }
                } catch (e) {
                  // Use the raw error text if we can't parse JSON
                  if (errorText) {
                    errorMessage = `Zendesk Error: ${errorText}`;
                  }
                }
                
                throw new Error(errorMessage);
              }
              
              const ticketResult = await createTicketRes.json();
              const ticketId = ticketResult.ticket_id;
              
              // Step 2: If we have a ticket ID and attachments, upload them
              if (ticketId && attachmentKeys && attachmentKeys.length > 0 && attachmentKeys[0] !== 'skipped-attachments') {
                // Process and upload file attachments directly
                // First, collect the upload tokens
                const uploadTokens = [];
                
                for (const file of files) {
                  debugLog('Processing file for upload to Zendesk', { id: file.id, name: file.file?.name, status: file.status });
                  // Skip processed files or error files
                  if (!file.file || file.status.includes('Error')) {
                    debugLog('Skipping file due to missing file or error status', { id: file.id });
                    continue;
                  }
                  
                  // Update status
                  updateFileStatus(file.id, 'Uploading to Zendesk...');
                  
                  try {
                    // 1. Get upload token from our API
                    debugLog('Requesting upload token from API for file', { name: file.file.name });
                    const baseUrl = window.location.origin;
                    const uploadTokenUrl = `${baseUrl}/api/zendesk/upload-url`;
                    debugLog('Requesting upload token from URL:', uploadTokenUrl);
                    const tokenRes = await fetch(uploadTokenUrl, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({
                        fileName: file.file.name,
                        contentType: file.file.type,
                        size: file.file.size
                      })
                    });
                    
                    debugLog('Upload token response', { status: tokenRes.status, statusText: tokenRes.statusText });
                    if (!tokenRes.ok) {
                      debugLog('Failed to get upload token from API', { status: tokenRes.status, statusText: tokenRes.statusText });
                      throw new Error(`Failed to get upload token: ${tokenRes.statusText}`);
                    }
                    
                    const tokenData = await tokenRes.json();
                    debugLog('Upload token data received', tokenData);
                    const { token, attachment_id } = tokenData.upload;
                    
                    if (token) {
                      debugLog('Valid upload token received', { token, attachment_id });
                      uploadTokens.push(token);
                      updateFileStatus(file.id, 'Uploaded to Zendesk');
                      debugLog('File status updated to Uploaded to Zendesk', { id: file.id });
                    }
                  } catch (uploadError) {
                    debugLog('Error uploading file to Zendesk', { file: file.file.name, error: uploadError.message });
                    console.error(`Error uploading file ${file.file.name}:`, uploadError);
                    updateFileStatus(file.id, 'Upload to Zendesk failed');
                  }
                }
                
                // Now attach the uploads to the ticket
                debugLog('Collected upload tokens', { count: uploadTokens.length, tokens: uploadTokens });
                if (uploadTokens.length > 0) {
                  debugLog('Attaching uploads to ticket', { ticketId, tokenCount: uploadTokens.length });
                  const baseUrl = window.location.origin;
                  const attachUrl = `${baseUrl}/api/zendesk/create-ticket/attach`;
                  debugLog('Attaching uploads to ticket using URL:', attachUrl);
                  const uploadRes = await fetch(attachUrl, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                      ticketId: ticketId,
                      uploadTokens: uploadTokens
                    })
                  });
                
                debugLog('Attachment API response', { status: uploadRes?.status, statusText: uploadRes?.statusText });
                if (!uploadRes.ok) {
                  debugLog('Failed to upload attachments to ticket, but ticket was created', { status: uploadRes.status });
                  console.warn('Failed to upload attachments to Zendesk, but ticket was created');
                  
                  // Show warning about attachment upload failure
                  const attachmentWarning = document.createElement('div');
                  attachmentWarning.style.cssText = 'background-color: rgba(255, 193, 7, 0.1); color: #ffc107; padding: 10px; border-radius: 4px; margin-top: 16px; text-align: left;';
                  attachmentWarning.innerHTML = `
                    <strong>Note:</strong> Your bug report was created successfully, but we couldn't upload your attachments. 
                    The support team may contact you for these files if needed.
                  `;
                  
                  // We'll add this warning to the success message later
                  window.attachmentWarningHTML = attachmentWarning.outerHTML;
                }
              }
              
              // Show enhanced success message with Zendesk ticket ID
              bugReportForm.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                  <div style="background-color: #28a745; color: white; border-radius: 50%; width: 60px; height: 60px; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                  </div>
                  <h2 style="color: #28a745; margin-bottom: 16px;">Bug Report Submitted Successfully!</h2>
                  <div style="background-color: rgba(40, 167, 69, 0.1); border-radius: 8px; padding: 16px; margin-bottom: 20px; text-align: left;">
                    <p><strong>Thank you for your feedback.</strong> Your report has been submitted to our support team via Zendesk.</p>
                    <p><strong>Ticket Details:</strong></p>
                    <ul style="list-style-type: none; padding-left: 0;">
                      <li><strong>Ticket ID:</strong> ${ticketId || 'N/A'}</li>
                      <li><strong>Submitted by:</strong> ${formData.reporterName}</li>
                      <li><strong>Severity:</strong> ${formData.severity}</li>
                      <li><strong>Attachments:</strong> ${attachmentKeys && attachmentKeys.length > 0 && attachmentKeys[0] !== 'skipped-attachments' ? attachmentKeys.length + ' file(s)' : 'None'}</li>
                    </ul>
                    <p style="margin-top: 16px;">Our support team has been notified and will investigate this issue. You'll receive email updates at <strong>${formData.reporterEmail}</strong> as we work on your report.</p>
                  </div>
                  <div style="display: flex; justify-content: center; gap: 16px;">
                    <a href="/" class="back-button" style="display: flex; align-items: center; border-radius: 9999px; padding: 8px 20px; font-weight: 500; font-size: 16px;">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12 19 5 12 12 5"></polyline>
                      </svg>
                      Return to Home
                    </a>
                    <button onclick="submitAnotherReport()" class="button" style="display: flex; align-items: center;">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
                        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                      </svg>
                      Submit Another Report
                    </button>
                  </div>
                </div>
              `;
              
              // Add function to reload the form
              window.submitAnotherReport = function() {
                location.reload();
              };
              
              return true;
            } catch (zendeskError) {
              debugLog('Zendesk submission error', { message: zendeskError.message, stack: zendeskError.stack });
              console.error('Zendesk submission error:', zendeskError);
              
              // Re-enable submit button
              submitButton.disabled = false;
              submitButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2v20h-20v-20h20zm-10 10v6m0-12v2m-6 16v-12m12 12v-12"></path></svg> Submit Bug Report';
              
              // Add Zendesk-specific error info
              const enhancedError = new Error(`Zendesk: ${zendeskError.message}`);
              throw enhancedError;
            }
          }
          
          catch (apiError) {
            console.error('API submission error:', apiError);
            
            // Display error with retry option
            submitButton.disabled = false;
            submitButton.textContent = 'Submit Bug Report';
            
            // Check if this is a Zendesk-specific error
            const isZendeskError = window.USE_ZENDESK && apiError.message && 
                               (apiError.message.includes('Zendesk') || 
                                apiError.message.includes('zendesk'));
            
            // Add error message at the top of the form
            const errorElement = document.createElement('div');
            errorElement.className = 'form-error';
            
            if (isZendeskError) {
              // Enhanced error handling for Zendesk errors
              errorElement.innerHTML = `
                <div style="background-color: rgba(220, 53, 69, 0.1); color: #dc3545; padding: 16px; border-radius: 4px; margin-bottom: 16px;">
                  <div style="display: flex; align-items: flex-start;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#dc3545" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 10px; flex-shrink: 0;">
                      <circle cx="12" cy="12" r="10"></circle>
                      <line x1="12" y1="8" x2="12" y2="12"></line>
                      <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                    <div>
                      <strong>Error connecting to Zendesk support system</strong>
                      <p>${apiError.message}</p>
                      <div style="margin-top: 10px;">
                        <p><strong>What you can do:</strong></p>
                        <ol style="margin-left: 20px;">
                          <li>Try submitting again</li>
                          <li>Check your internet connection</li>
                          <li>Contact our support team at <a href="mailto:support@example.com" style="color: #dc3545;">support@example.com</a></li>
                        </ol>
                      </div>
                      <div style="margin-top: 10px;">
                        <button id="fallbackSubmissionBtn" class="button" style="background-color: #dc3545; margin-right: 10px;">Use Alternative Submission Method</button>
                        <button id="dismissErrorBtn" class="button">Dismiss</button>
                      </div>
                    </div>
                  </div>
                </div>
              `;
            } else {
              // Generic error handling
              errorElement.innerHTML = `
                <div style="background-color: rgba(220, 53, 69, 0.1); color: #dc3545; padding: 10px; border-radius: 4px; margin-bottom: 16px;">
                  <strong>Error submitting report:</strong> ${apiError.message}
                  <p>Please try again or contact support if the problem persists.</p>
                </div>
              `;
            }
            
            // Insert at the beginning of the form
            bugReportForm.insertBefore(errorElement, bugReportForm.firstChild);
            
            // Scroll to the top to show the error
            window.scrollTo(0, 0);
            
            // Add event listeners for fallback and dismiss buttons if they exist
            const fallbackBtn = document.getElementById('fallbackSubmissionBtn');
            if (fallbackBtn) {
              fallbackBtn.addEventListener('click', function() {
                // Remove the error message
                errorElement.remove();
                
                // Temporarily disable Zendesk and retry submission
                window.USE_ZENDESK = false;
                submitReport();
              });
            }
            
            const dismissBtn = document.getElementById('dismissErrorBtn');
            if (dismissBtn) {
              dismissBtn.addEventListener('click', function() {
                // Just remove the error message
                errorElement.remove();
              });
            }
          }
          
        } catch (error) {
          console.error('Submission error:', error);
          alert(`Error submitting report: ${error.message}`);
          
          // Re-enable submit button
          submitButton.disabled = false;
          submitButton.textContent = 'Submit Bug Report';
        }
      }
      
      // Clean up when page is unloaded
      window.addEventListener('beforeunload', function() {
        // Clear all polling intervals
        Object.values(pollingIntervals).forEach(interval => {
          clearInterval(interval);
        });
      });
      
      // Initialize the page
      try {
        console.log('Attempting to initialize the page...');
        init();
        console.log('Page initialization completed');
      } catch (err) {
        console.error('Error during initialization:', err);
      }
    });
  </script>
</body>
</html>